<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <title>Kilpailutulokset | scores.html</title>
  <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.4/dist/dexie.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    li {
      cursor: move;
      margin: 5px;
      padding: 8px;
      background: #f9f9f9;
      border: 1px solid #ccc;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    button {
      margin-left: 5px;
    }
    .nappi-ryhma {
      display: flex;
    }
  </style>
</head>
<body>
  <h1>Kilpailutulokset</h1>

  <form id="form">
    <input type="text" id="nimi" placeholder="Nimi" required>
    <input type="number" id="numero" placeholder="Numero" required>
    <input type="number" id="tulos" step="0.01" placeholder="Tulos" required>
    <button type="submit" id="lisaaNappi">Lisää kilpailija</button>
    <button type="button" id="peruMuokkaus" style="display:none;">Peruuta</button>
  </form>

  <button id="palautaJarjestys">Palauta tulosjärjestys</button>
  <button id="vieJson">Vie JSON</button>

  <ul id="kilpailijat"></ul>

  <script>
    const db = new Dexie("KilpailutuloksetDB");
    db.version(14).stores({
      kilpailijat: "++id,nimi,numero,tulos"
    });

    let muokattavaId = null;

    document.getElementById('form').addEventListener('submit', async function (e) {
      e.preventDefault();
      const nimi = document.getElementById('nimi').value.trim();
      const numero = parseInt(document.getElementById('numero').value);
      const tulos = parseFloat(document.getElementById('tulos').value).toFixed(2);

      if (muokattavaId !== null) {
        await db.kilpailijat.update(muokattavaId, { nimi, numero, tulos });
        muokattavaId = null;
        document.getElementById('lisaaNappi').textContent = "Lisää kilpailija";
        document.getElementById('peruMuokkaus').style.display = "none";
      } else {
        await db.kilpailijat.add({ nimi, numero, tulos });
      }

      this.reset();
      lataaKilpailijat();
    });

    document.getElementById('peruMuokkaus').addEventListener('click', () => {
      muokattavaId = null;
      document.getElementById('form').reset();
      document.getElementById('lisaaNappi').textContent = "Lisää kilpailija";
      document.getElementById('peruMuokkaus').style.display = "none";
    });

    document.getElementById('palautaJarjestys').addEventListener('click', () => {
      lataaKilpailijat();
    });

    document.getElementById('vieJson').addEventListener('click', async () => {
      const data = await db.kilpailijat.orderBy('tulos').reverse().toArray();
      const json = JSON.stringify(data, null, 2);
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = "kilpailijat.json";
      a.click();

      URL.revokeObjectURL(url);
    });

    async function lataaKilpailijat() {
      const data = await db.kilpailijat.orderBy('tulos').reverse().toArray();
      const ul = document.getElementById('kilpailijat');
      ul.innerHTML = '';

      data.forEach(item => {
        const li = document.createElement('li');
        li.dataset.id = item.id;

        const vasen = document.createElement('span');
        vasen.textContent = `${item.nimi} (#${item.numero}) – ${item.tulos}`;

        const oikea = document.createElement('span');
        oikea.classList.add("nappi-ryhma");

        const muokkaaBtn = document.createElement('button');
        muokkaaBtn.textContent = "Muokkaa";
        muokkaaBtn.addEventListener('click', () => {
          document.getElementById('nimi').value = item.nimi;
          document.getElementById('numero').value = item.numero;
          document.getElementById('tulos').value = item.tulos;
          muokattavaId = item.id;
          document.getElementById('lisaaNappi').textContent = "Päivitä kilpailija";
          document.getElementById('peruMuokkaus').style.display = "inline-block";
        });

        const poistaBtn = document.createElement('button');
        poistaBtn.textContent = "Poista";
        poistaBtn.style.background = "red";
        poistaBtn.style.color = "white";
        poistaBtn.addEventListener('click', async () => {
          await db.kilpailijat.delete(item.id);
          lataaKilpailijat();
        });

        oikea.appendChild(muokkaaBtn);
        oikea.appendChild(poistaBtn);

        li.appendChild(vasen);
        li.appendChild(oikea);
        ul.appendChild(li);
      });
    }

    new Sortable(document.getElementById('kilpailijat'), {
      animation: 150
    });

    lataaKilpailijat();
  </script>
</body>
</html>